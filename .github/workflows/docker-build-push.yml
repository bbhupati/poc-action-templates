  on:
    workflow_call:

  jobs:

    # get-env:
    #   uses: bbhupati/poc-action-templates/.github/workflows/set-env.yml@master

    docker-build-push:
      runs-on: ubuntu-latest
      # needs: get-env
      steps:
        - name: Checkout code
          uses: actions/checkout@v2
          
        - name: Read environment file and set environment variables
          run: |
            env
            ENV_FILE=".github/workflows/${{ env.environment_type }}-vars.env"
            cat $ENV_FILE >> $GITHUB_ENV
            echo "Loaded $ENV_FILE into environment variables"

        - name: Docker Build and Push
          run: |
            CONTAINER_IMAGE_NAME=$ACR_REGISTRY/$IMAGE_NAME:${{ github.run_id }}
    
            # Docker Log in to Azure Container Registry (ACR)
            echo "docker login -u $ACR_USERNAME -p ${{ secrets.ACR_PASSWORD }} $ACR_REGISTRY"
    
            # Build the Docker image
            echo "docker build -t $CONTAINER_IMAGE_NAME ."
    
            # Push Docker Image to ACR
            echo "docker push $CONTAINER_IMAGE_NAME"

            echo "successfully pushed $CONTAINER_IMAGE_NAME"
